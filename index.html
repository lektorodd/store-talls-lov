<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Store talls lov - simulator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Legger til JetBrains Mono font -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --accent-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --coin-color: #f1c40f;
            --coin-text: #b7950b;
            --coin-silver: #bdc3c7;
            --coin-silver-text: #7f8c8d;
            --background-color: #f4f7f6;
            --dice-bg: #fff;
            --dice-dot: #333;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            color: var(--secondary-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh; /* Sikrer at footer havner nederst */
            box-sizing: border-box;
        }

        h1 { margin-bottom: 10px; text-align: center; }
        p.subtitle { max-width: 600px; text-align: center; margin-bottom: 20px; color: #666; }

        /* Mode Switcher (Tabs) */
        .mode-switcher {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: white;
            padding: 5px;
            border-radius: 50px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .mode-btn {
            border: none;
            background: transparent;
            padding: 10px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            color: #7f8c8d;
            transition: all 0.3s;
        }

        .mode-btn.active {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 2px 5px rgba(52, 152, 219, 0.4);
        }

        /* Section Visibility */
        .app-section { 
            display: none; 
            width: 100%; 
            flex-direction: column; 
            align-items: center; 
        }
        
        .app-section.active { 
            display: flex; 
        }

        /* Kontrollpanel */
        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            flex-wrap: wrap;
            gap: 15px; /* 칒kt gap litt for 친 gi plass til slider */
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            width: 100%;
            max-width: 950px; /* Litt bredere for 친 f친 plass til alt */
        }

        select { padding: 10px; border-radius: 5px; border: 1px solid #ddd; font-size: 16px; margin-right: 10px; cursor: pointer; }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        button:hover { background-color: #2980b9; }
        button.analyze-btn { background-color: var(--accent-color); }
        button.analyze-btn:hover { background-color: #219150; }
        button.reset-btn { background-color: var(--danger-color); }
        button.reset-btn:hover { background-color: #c0392b; }
        
        button.auto-btn { background-color: var(--secondary-color); }
        button.auto-btn:hover { background-color: #34495e; }
        button.auto-btn.active { background-color: var(--danger-color); animation: pulse 1.5s infinite; }

        button.new-series-btn { background-color: var(--warning-color); color: #fff; }
        button.new-series-btn:hover { background-color: #d35400; }

        /* Speed Control Slider */
        .speed-control {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0 10px;
            border-left: 1px solid #eee;
            border-right: 1px solid #eee;
        }
        .speed-control label {
            font-size: 0.75em;
            color: #7f8c8d;
            margin-bottom: 2px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .speed-control input[type=range] {
            width: 100px;
            cursor: pointer;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); }
            100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }

        /* Terning Visualisering */
        .dice-container { display: flex; gap: 20px; margin: 20px 0; height: 80px; justify-content: center; align-items: center; }
        .die {
            width: 60px; height: 60px; background-color: var(--dice-bg); border-radius: 10px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2); display: grid; grid-template: repeat(3, 1fr) / repeat(3, 1fr); padding: 4px; box-sizing: border-box;
        }
        .dot { background-color: var(--dice-dot); border-radius: 50%; width: 8px; height: 8px; align-self: center; justify-self: center; opacity: 0; }

        /* Dot patterns */
        .die[data-value="1"] .dot:nth-child(5) { opacity: 1; }
        .die[data-value="2"] .dot:nth-child(1), .die[data-value="2"] .dot:nth-child(9) { opacity: 1; }
        .die[data-value="3"] .dot:nth-child(1), .die[data-value="3"] .dot:nth-child(5), .die[data-value="3"] .dot:nth-child(9) { opacity: 1; }
        .die[data-value="4"] .dot:nth-child(1), .die[data-value="4"] .dot:nth-child(3), .die[data-value="4"] .dot:nth-child(7), .die[data-value="4"] .dot:nth-child(9) { opacity: 1; }
        .die[data-value="5"] .dot:nth-child(1), .die[data-value="5"] .dot:nth-child(3), .die[data-value="5"] .dot:nth-child(5), .die[data-value="5"] .dot:nth-child(7), .die[data-value="5"] .dot:nth-child(9) { opacity: 1; }
        .die[data-value="6"] .dot:nth-child(1), .die[data-value="6"] .dot:nth-child(3), .die[data-value="6"] .dot:nth-child(4), .die[data-value="6"] .dot:nth-child(6), .die[data-value="6"] .dot:nth-child(7), .die[data-value="6"] .dot:nth-child(9) { opacity: 1; }

        /* Mynt Visualisering */
        .coin-container { margin: 20px 0; height: 80px; display: flex; align-items: center; justify-content: center; perspective: 1000px; }
        .coin {
            width: 70px; height: 70px; background-color: var(--coin-color); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 32px; font-weight: bold; color: var(--coin-text);
            border: 4px solid #d4ac0d; box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: transform 0.5s ease-in-out;
        }
        .coin.flip { transform: rotateY(720deg); }

        /* Mynt Historikk (Sm친 prikker) */
        .coin-history-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            justify-content: center;
            max-width: 800px;
            margin-bottom: 20px;
            min-height: 30px; /* Holder plassen 친pen selv om tom */
        }
        
        .coin-dot {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .coin-dot.heads {
            background-color: var(--coin-color);
            color: var(--coin-text);
            border: 1px solid #d4ac0d;
        }

        .coin-dot.tails {
            background-color: var(--coin-silver);
            color: var(--coin-silver-text);
            border: 1px solid #95a5a6;
        }

        .history-limit-msg {
            font-style: italic;
            color: #888;
            font-size: 0.9em;
            margin-top: 10px;
        }

        /* Animasjon Terning */
        @keyframes shake {
            0% { transform: rotate(0deg); } 25% { transform: rotate(15deg); }
            50% { transform: rotate(-15deg); } 75% { transform: rotate(5deg); } 100% { transform: rotate(0deg); }
        }
        .shaking { animation: shake 0.3s ease-in-out infinite; }

        .stats { font-size: 1.2em; margin-bottom: 10px; font-weight: bold; }
        .chart-container { width: 100%; max-width: 800px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        /* Footer */
        footer {
            margin-top: auto;
            padding-top: 40px;
            padding-bottom: 10px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
        }

        footer a {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #7f8c8d;
            text-decoration: none;
            transition: color 0.2s;
        }

        footer a:hover {
            color: var(--secondary-color);
        }

        .github-icon {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 30px; border: 1px solid #888; width: 90%; max-width: 800px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-btn:hover { color: #333; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; margin-bottom: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: var(--primary-color); color: white; }
        .expectation-box { background-color: #e8f6f3; border-left: 5px solid var(--accent-color); padding: 15px; margin-bottom: 20px; border-radius: 4px; }
        .calc-val { font-weight: bold; font-size: 1.1em; color: var(--primary-color); }
    </style>
</head>
<body>

    <h1>Store talls lov</h1>
    
    <div class="mode-switcher">
        <button class="mode-btn active" onclick="switchMode('dice')">游 Terninger</button>
        <button class="mode-btn" onclick="switchMode('coin')">游뿣 Myntkast</button>
    </div>

    <!-- TERNING SEKSJON -->
    <div id="diceSection" class="app-section active">
        <p class="subtitle">
            Kast terninger og se fordelingen av summene. Den r칮de linjen viser den <strong>teoretiske</strong> fordelingen.
        </p>

        <div class="controls">
            <label for="diceCount">Antall: </label>
            <select id="diceCount">
                <option value="1">1 Terning</option>
                <option value="2" selected>2 Terninger</option>
                <option value="3">3 Terninger</option>
            </select>
            
            <button onclick="rollSingleWithAnimation()">Kast 1</button>
            <button onclick="rollMany(100)">Kast 100</button>
            <button onclick="rollMany(1000)">Kast 1000</button>
            
            <div style="border-left: 1px solid #ddd; height: 30px; margin: 0 5px;"></div>
            
            <!-- Tempo Kontroll -->
            <div class="speed-control">
                <label for="diceSpeed">Tempo</label>
                <input type="range" id="diceSpeed" min="1" max="50" value="10" title="Juster hastigheten p친 auto-kast">
            </div>
            
            <button onclick="toggleDiceAutoRoll()" id="diceAutoBtn" class="auto-btn">Start Auto</button>
            
            <div style="border-left: 1px solid #ddd; height: 30px; margin: 0 5px;"></div>

            <button onclick="openAnalysis()" class="analyze-btn">游늵 Tabell</button>
            <button onclick="resetDiceData()" class="reset-btn">Nullstill</button>
        </div>

        <div class="dice-container" id="diceVisuals">
            <!-- JS fyller inn her -->
        </div>

        <div class="stats">Totalt antall kast: <span id="totalRollsDice">0</span></div>
    </div>

    <!-- MYNT SEKSJON -->
    <div id="coinSection" class="app-section">
        <p class="subtitle">
            Kast mynt og se hvordan den relative frekvensen for "Kron" stabiliserer seg mot 0.5 over tid. 
            Start en <strong>ny serie</strong> for 친 se at alle serier konvergerer mot det samme.
        </p>

        <div class="controls">
            <button onclick="flipCoinWithAnimation()">Kast 1</button>
            <button onclick="flipMany(100)">Kast 100</button>
            <button onclick="flipMany(1000)">Kast 1000</button>
            
            <div style="border-left: 1px solid #ddd; height: 30px; margin: 0 5px;"></div>

            <!-- Tempo Kontroll -->
            <div class="speed-control">
                <label for="coinSpeed">Tempo</label>
                <input type="range" id="coinSpeed" min="1" max="50" value="10" title="Juster hastigheten p친 auto-kast">
            </div>

            <button onclick="toggleCoinAutoFlip()" id="coinAutoBtn" class="auto-btn">Start Auto</button>
            
            <div style="border-left: 1px solid #ddd; height: 30px; margin: 0 5px;"></div>

            <button onclick="startNewCoinSeries()" class="new-series-btn" title="Start en ny graf-linje med ny farge">Ny Serie</button>
            <button onclick="resetCoinData()" class="reset-btn">Slett alt</button>
        </div>

        <div class="coin-container">
            <div id="coinVisual" class="coin">K</div>
        </div>

        <!-- Container for sm친 mynt-prikker -->
        <div id="coinHistoryVisuals" class="coin-history-container"></div>
        <div id="coinHistoryMsg" class="history-limit-msg" style="display: none;">Visning av enkeltkast skjult pga. stor mengde data (>200).</div>

        <div class="stats">
            Kast (denne serien): <span id="totalFlipsCoin">0</span> | 
            Kron: <span id="headsCount">0</span> | 
            Frekvens: <span id="relFreq">0.000</span>
        </div>
    </div>

    <!-- FELLES GRAF -->
    <div class="chart-container">
        <canvas id="myChart"></canvas>
    </div>

    <footer>
        <a href="https://github.com/lektorodd/store-talls-lov/" target="_blank">
            <svg class="github-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/>
            </svg>
            lektorodd
        </a>
    </footer>

    <!-- ANALYSE MODAL (Kun for terninger) -->
    <div id="analysisModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeAnalysis()">&times;</span>
            <h2>Analyse (Terninger)</h2>
            <div class="expectation-box">
                <h3>Forventningsverdi (E[X])</h3>
                <p>Teoretisk: <span id="theoExpectation" class="calc-val">-</span></p>
                <p>Empirisk: <span id="empExpectation" class="calc-val">-</span></p>
            </div>
            <table id="statsTable">
                <thead>
                    <tr><th>Sum</th><th>Antall</th><th>Frekvens (%)</th><th>Teoretisk (%)</th><th>Avvik</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        // --- Globale Variabler ---
        let currentMode = 'dice'; // 'dice' eller 'coin'
        let myChart = null;
        let isAnimating = false;
        
        // Auto-roll timers
        let diceAutoInterval = null;
        let coinAutoInterval = null;

        // Dice state
        let diceTotalRolls = 0;
        let diceCounts = {}; 
        let diceSumTotal = 0;

        // Coin state (Multi-series)
        let savedCoinSeries = []; 
        let currentCoinHistory = []; 
        let coinTotalFlips = 0; 
        let headsTotal = 0;     
        let seriesColorIndex = 0;
        
        const MAX_VISUAL_COINS = 200; 

        // DOM Elements
        const diceSection = document.getElementById('diceSection');
        const coinSection = document.getElementById('coinSection');
        const diceVisualsEl = document.getElementById('diceVisuals');
        const coinVisualEl = document.getElementById('coinVisual');
        const coinHistoryVisualsEl = document.getElementById('coinHistoryVisuals');
        const coinHistoryMsgEl = document.getElementById('coinHistoryMsg');
        const diceSelect = document.getElementById('diceCount');
        const analysisModal = document.getElementById('analysisModal');
        const diceAutoBtn = document.getElementById('diceAutoBtn');
        const coinAutoBtn = document.getElementById('coinAutoBtn');
        
        const diceSpeedInput = document.getElementById('diceSpeed');
        const coinSpeedInput = document.getElementById('coinSpeed');

        // Init
        initApp();

        function initApp() {
            resetDiceData();
            resetCoinData();
            updateDiceVisuals([1, 1]);
        }

        // --- Mode Switching ---
        function switchMode(mode) {
            currentMode = mode;
            stopAllAuto(); 

            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.mode-btn[onclick="switchMode('${mode}')"]`).classList.add('active');

            if (mode === 'dice') {
                diceSection.classList.add('active');
                coinSection.classList.remove('active');
                renderDiceChart();
            } else {
                coinSection.classList.add('active');
                diceSection.classList.remove('active');
                renderCoinChart();
            }
        }

        function stopAllAuto() {
            if (diceAutoInterval) toggleDiceAutoRoll();
            if (coinAutoInterval) toggleCoinAutoFlip();
        }

        // ================= TERNING LOGIKK =================

        diceSelect.addEventListener('change', () => {
            resetDiceData(); 
            const numDice = parseInt(diceSelect.value);
            updateDiceVisuals(Array(numDice).fill(1));
        });

        // Oppdater hastighet live (Terning)
        diceSpeedInput.addEventListener('input', () => {
            if (diceAutoInterval) {
                // Hvis den kj칮rer, restart med ny hastighet
                clearInterval(diceAutoInterval);
                const speedVal = parseInt(diceSpeedInput.value);
                // Beregn delay: H칮yere verdi = lavere delay (raskere)
                // Range 1-50. Delay fra 1000ms til 20ms.
                const delay = 1000 / speedVal;
                diceAutoInterval = setInterval(() => rollMany(5), delay);
            }
        });

        function rollDice() {
            const numDice = parseInt(diceSelect.value);
            const results = [];
            let sum = 0;
            for (let i = 0; i < numDice; i++) {
                const roll = Math.floor(Math.random() * 6) + 1;
                results.push(roll);
                sum += roll;
            }
            return { results, sum };
        }

        function rollSingleWithAnimation() {
            if (isAnimating || diceAutoInterval) return; 
            isAnimating = true;
            const diceEls = diceVisualsEl.querySelectorAll('.die');
            diceEls.forEach(el => el.classList.add('shaking'));

            setTimeout(() => {
                diceEls.forEach(el => el.classList.remove('shaking'));
                const { results, sum } = rollDice();
                updateDiceData(sum);
                updateDiceVisuals(results);
                updateDiceUI();
                isAnimating = false;
            }, 400);
        }

        function rollMany(count) {
            if (isAnimating) return;
            
            let lastResults = [];
            for (let i = 0; i < count; i++) {
                const { results, sum } = rollDice();
                updateDiceData(sum);
                lastResults = results;
            }
            updateDiceVisuals(lastResults);
            updateDiceUI();
        }

        function toggleDiceAutoRoll() {
            if (diceAutoInterval) {
                clearInterval(diceAutoInterval);
                diceAutoInterval = null;
                diceAutoBtn.classList.remove('active');
                diceAutoBtn.innerText = "Start Auto";
            } else {
                diceAutoBtn.classList.add('active');
                diceAutoBtn.innerText = "Stopp Auto";
                
                const speedVal = parseInt(diceSpeedInput.value);
                const delay = 1000 / speedVal;
                
                diceAutoInterval = setInterval(() => {
                    rollMany(5); 
                }, delay);
            }
        }

        function updateDiceData(sum) {
            diceTotalRolls++;
            diceSumTotal += sum;
            if (!diceCounts[sum]) diceCounts[sum] = 0;
            diceCounts[sum]++;
        }

        function resetDiceData() {
            if (diceAutoInterval) toggleDiceAutoRoll(); 
            diceTotalRolls = 0;
            diceSumTotal = 0;
            diceCounts = {};
            const numDice = parseInt(diceSelect.value);
            const minSum = numDice;
            const maxSum = numDice * 6;
            for (let i = minSum; i <= maxSum; i++) diceCounts[i] = 0;
            
            const initialDice = Array(numDice).fill(1);
            createDiceElements(numDice);
            updateDiceVisuals(initialDice);
            updateDiceUI();
        }

        function createDiceElements(count) {
            diceVisualsEl.innerHTML = '';
            for(let i=0; i<count; i++) {
                const die = document.createElement('div');
                die.className = 'die';
                die.dataset.value = '1';
                for(let j=0; j<9; j++) die.appendChild(document.createElement('div')).className = 'dot';
                diceVisualsEl.appendChild(die);
            }
        }

        function updateDiceVisuals(results) {
            const currentDiceEls = diceVisualsEl.querySelectorAll('.die');
            if (currentDiceEls.length !== results.length) createDiceElements(results.length);
            diceVisualsEl.querySelectorAll('.die').forEach((el, i) => el.dataset.value = results[i]);
        }

        function updateDiceUI() {
            document.getElementById('totalRollsDice').innerText = diceTotalRolls;
            if (currentMode === 'dice') renderDiceChart();
        }

        // ================= MYNT LOGIKK =================

        // Oppdater hastighet live (Mynt)
        coinSpeedInput.addEventListener('input', () => {
            if (coinAutoInterval) {
                clearInterval(coinAutoInterval);
                const speedVal = parseInt(coinSpeedInput.value);
                const delay = 1000 / speedVal;
                coinAutoInterval = setInterval(() => flipMany(5), delay);
            }
        });

        function flipCoin() {
            const isHeads = Math.random() < 0.5;
            return isHeads;
        }

        function flipCoinWithAnimation() {
            if (isAnimating || coinAutoInterval) return;
            isAnimating = true;

            coinVisualEl.classList.add('flip');

            setTimeout(() => {
                const isHeads = flipCoin();
                coinVisualEl.innerText = isHeads ? "K" : "M";
                coinVisualEl.style.backgroundColor = isHeads ? "#f1c40f" : "#bdc3c7";
                
                updateCoinData(isHeads);
                addCoinDot(isHeads);
                
                coinVisualEl.classList.remove('flip');
                updateCoinUI();
                isAnimating = false;
            }, 500);
        }

        function flipMany(count) {
            if (isAnimating) return;
            let lastResult = false;
            
            for(let i=0; i<count; i++) {
                const isHeads = flipCoin();
                updateCoinData(isHeads);
                lastResult = isHeads;
                
                if (coinTotalFlips <= MAX_VISUAL_COINS) {
                    addCoinDot(isHeads);
                }
            }

            coinVisualEl.innerText = lastResult ? "K" : "M";
            coinVisualEl.style.backgroundColor = lastResult ? "#f1c40f" : "#bdc3c7";
            
            if (coinTotalFlips > MAX_VISUAL_COINS) {
                coinHistoryVisualsEl.innerHTML = '';
                coinHistoryMsgEl.style.display = 'block';
            }
            
            updateCoinUI();
        }

        function toggleCoinAutoFlip() {
            if (coinAutoInterval) {
                clearInterval(coinAutoInterval);
                coinAutoInterval = null;
                coinAutoBtn.classList.remove('active');
                coinAutoBtn.innerText = "Start Auto";
            } else {
                coinAutoBtn.classList.add('active');
                coinAutoBtn.innerText = "Stopp Auto";
                
                const speedVal = parseInt(coinSpeedInput.value);
                const delay = 1000 / speedVal;
                
                coinAutoInterval = setInterval(() => {
                    flipMany(5);
                }, delay);
            }
        }

        function updateCoinData(isHeads) {
            coinTotalFlips++;
            if (isHeads) headsTotal++;
            
            currentCoinHistory.push({
                x: coinTotalFlips,
                y: headsTotal / coinTotalFlips
            });
        }

        function startNewCoinSeries() {
            if (coinTotalFlips === 0) return; 

            const colors = ['#bdc3c7', '#95a5a6', '#7f8c8d']; 
            const color = colors[seriesColorIndex % colors.length];
            seriesColorIndex++;
            
            savedCoinSeries.push({
                label: `Serie ${savedCoinSeries.length + 1}`,
                data: [...currentCoinHistory],
                borderColor: color,
                backgroundColor: 'transparent',
                borderWidth: 1,
                pointRadius: 0,
                tension: 0.1,
                fill: false
            });

            currentCoinHistory = [];
            coinTotalFlips = 0;
            headsTotal = 0;
            
            coinHistoryVisualsEl.innerHTML = '';
            coinHistoryMsgEl.style.display = 'none';
            coinVisualEl.innerText = "K";
            coinVisualEl.style.backgroundColor = "#f1c40f";

            updateCoinUI();
        }

        function addCoinDot(isHeads) {
            if (coinTotalFlips > MAX_VISUAL_COINS) {
                coinHistoryVisualsEl.innerHTML = '';
                coinHistoryMsgEl.style.display = 'block';
                return;
            }
            const dot = document.createElement('div');
            dot.className = `coin-dot ${isHeads ? 'heads' : 'tails'}`;
            dot.innerText = isHeads ? 'K' : 'M';
            coinHistoryVisualsEl.appendChild(dot);
        }

        function resetCoinData() {
            if (coinAutoInterval) toggleCoinAutoFlip();
            coinTotalFlips = 0;
            headsTotal = 0;
            currentCoinHistory = [];
            savedCoinSeries = []; 
            seriesColorIndex = 0;
            
            document.getElementById('coinVisual').innerText = "K";
            document.getElementById('coinVisual').style.backgroundColor = "#f1c40f";
            
            coinHistoryVisualsEl.innerHTML = '';
            coinHistoryMsgEl.style.display = 'none';
            
            updateCoinUI();
        }

        function updateCoinUI() {
            document.getElementById('totalFlipsCoin').innerText = coinTotalFlips;
            document.getElementById('headsCount').innerText = headsTotal;
            const freq = coinTotalFlips > 0 ? (headsTotal / coinTotalFlips).toFixed(4) : "0.000";
            document.getElementById('relFreq').innerText = freq;
            
            if (currentMode === 'coin') renderCoinChart();
        }


        // ================= GRAF LOGIKK =================

        function getTheoreticalData(numDice, totalRolls) {
            if (totalRolls === 0) return [];
            
            let dist = {};
            let totalCombos = 0;
            
            if (numDice === 1) {
                for(let i=1; i<=6; i++) dist[i] = 1;
                totalCombos = 6;
            } else if (numDice === 2) {
                dist = { 2:1, 3:2, 4:3, 5:4, 6:5, 7:6, 8:5, 9:4, 10:3, 11:2, 12:1 };
                totalCombos = 36;
            } else if (numDice === 3) {
                dist = { 3:1, 4:3, 5:6, 6:10, 7:15, 8:21, 9:25, 10:27, 11:27, 12:25, 13:21, 14:15, 15:10, 16:6, 17:3, 18:1 };
                totalCombos = 216;
            }

            const minSum = numDice;
            const maxSum = numDice * 6;
            let data = [];
            
            for (let sum = minSum; sum <= maxSum; sum++) {
                const prob = (dist[sum] || 0) / totalCombos;
                data.push(prob * totalRolls);
            }
            return data;
        }

        function renderDiceChart() {
            const numDice = parseInt(diceSelect.value);
            const labels = Object.keys(diceCounts).map(Number).sort((a, b) => a - b);
            const data = labels.map(label => diceCounts[label]);
            
            const theoData = getTheoreticalData(numDice, diceTotalRolls);

            const ctx = document.getElementById('myChart').getContext('2d');

            if (myChart && myChart.config.type !== 'bar') {
                myChart.destroy();
                myChart = null;
            }

            if (myChart) {
                const currentLabels = myChart.data.labels;
                if (JSON.stringify(currentLabels) !== JSON.stringify(labels)) {
                    myChart.destroy();
                    createDiceChart(ctx, labels, data, theoData);
                } else {
                    myChart.data.datasets[0].data = data; 
                    if (myChart.data.datasets[1]) {
                        myChart.data.datasets[1].data = theoData; 
                    }
                    myChart.update('none');
                }
            } else {
                createDiceChart(ctx, labels, data, theoData);
            }
        }

        function createDiceChart(ctx, labels, data, theoData) {
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Antall forekomster (Dine kast)',
                            data: data,
                            backgroundColor: 'rgba(52, 152, 219, 0.6)',
                            borderColor: 'rgba(52, 152, 219, 1)',
                            borderWidth: 1,
                            order: 2
                        },
                        {
                            label: 'Teoretisk fordeling (Fasit)',
                            data: theoData,
                            type: 'line',
                            borderColor: '#e74c3c', 
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false,
                            tension: 0.3,
                            order: 1 
                        }
                    ]
                },
                options: {
                    responsive: true,
                    animation: { duration: 0 }, 
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Antall' } },
                        x: { title: { display: true, text: 'Sum' } }
                    },
                    plugins: { legend: { display: true } } 
                }
            });
        }

        function renderCoinChart() {
            const ctx = document.getElementById('myChart').getContext('2d');
            
            if (myChart && myChart.config.type !== 'line') {
                myChart.destroy();
                myChart = null;
            }

            const maxX = coinTotalFlips > 0 ? coinTotalFlips : 10;
            let globalMaxX = maxX;
            savedCoinSeries.forEach(s => {
                if(s.data.length > globalMaxX) globalMaxX = s.data.length;
            });

            const refLine = [{x: 0, y: 0.5}, {x: globalMaxX, y: 0.5}];
            
            const datasets = [
                {
                    label: 'Teoretisk Sannsynlighet (0.5)',
                    data: refLine,
                    borderColor: '#e74c3c',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    fill: false,
                    order: 0
                },
                ...savedCoinSeries, 
                {
                    label: 'N친v칝rende serie',
                    data: currentCoinHistory,
                    borderColor: '#f1c40f', 
                    backgroundColor: 'rgba(241, 196, 15, 0.1)',
                    borderWidth: 2,
                    pointRadius: 0,
                    pointHoverRadius: 4,
                    tension: 0.1,
                    fill: false,
                    order: 10
                }
            ];

            if (myChart) {
                myChart.data.datasets = datasets;
                myChart.options.scales.x.max = globalMaxX;
                myChart.update('none');
            } else {
                createCoinChart(ctx, datasets, globalMaxX);
            }
        }

        function createCoinChart(ctx, datasets, maxX) {
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    animation: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            title: { display: true, text: 'Antall kast' },
                            min: 0,
                            max: maxX
                        },
                        y: {
                            title: { display: true, text: 'Relativ Frekvens' },
                            min: 0,
                            max: 1
                        }
                    }
                }
            });
        }

        // --- Analyse Modal ---
        function openAnalysis() {
            const numDice = parseInt(diceSelect.value);
            const tableBody = document.querySelector('#statsTable tbody');
            tableBody.innerHTML = '';

            let theoDist, totalCombos, theoMean;
            
            if (numDice === 1) {
                theoDist = {1:1, 2:1, 3:1, 4:1, 5:1, 6:1};
                totalCombos = 6;
                theoMean = 3.5;
            } else if (numDice === 2) { 
                theoDist = { 2:1, 3:2, 4:3, 5:4, 6:5, 7:6, 8:5, 9:4, 10:3, 11:2, 12:1 }; 
                totalCombos = 36; 
                theoMean = 7; 
            } else { 
                theoDist = { 3:1, 4:3, 5:6, 6:10, 7:15, 8:21, 9:25, 10:27, 11:27, 12:25, 13:21, 14:15, 15:10, 16:6, 17:3, 18:1 }; 
                totalCombos = 216; 
                theoMean = 10.5; 
            }

            document.getElementById('theoExpectation').innerText = theoMean;
            let empMean = diceTotalRolls > 0 ? (diceSumTotal / diceTotalRolls).toFixed(4) : "0";
            document.getElementById('empExpectation').innerText = empMean;

            const minSum = numDice;
            const maxSum = numDice * 6;

            for (let sum = minSum; sum <= maxSum; sum++) {
                const count = diceCounts[sum] || 0;
                const observedFreq = diceTotalRolls > 0 ? (count / diceTotalRolls) * 100 : 0;
                const favorable = theoDist[sum] || 0;
                const theoProb = (favorable / totalCombos) * 100;
                const diff = observedFreq - theoProb;
                const diffColor = Math.abs(diff) < 1 ? 'green' : (Math.abs(diff) < 5 ? 'orange' : 'red');

                const row = `<tr>
                    <td><strong>${sum}</strong></td><td>${count}</td><td>${observedFreq.toFixed(2)}%</td>
                    <td>${theoProb.toFixed(2)}%</td><td style="color:${diffColor}">${diff > 0 ? '+' : ''}${diff.toFixed(2)}</td>
                </tr>`;
                tableBody.innerHTML += row;
            }
            analysisModal.style.display = "block";
        }
        function closeAnalysis() { analysisModal.style.display = "none"; }
        window.onclick = function(event) { if (event.target == analysisModal) closeAnalysis(); }

    </script>
</body>
</html>
